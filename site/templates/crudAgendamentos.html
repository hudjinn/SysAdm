<div id="createSchedulingModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('createSchedulingModal')">&times;</span>
        <h3>{{ text.create_new_scheduling }}</h3>
        <form id="createSchedulingForm">
            <label for="newSchedulingNome">{{ text.patient_name }}</label>
            <input type="text" id="newSchedulingNome" name="nomePaciente">
            
            <label for="newSchedulingEmail">{{ text.patient_email }}</label>
            <input type="email" id="newSchedulingEmail" name="emailPaciente">
            
            <label for="newSchedulingClinica">{{ text.clinic }}</label>
            <select id="newSchedulingClinica" name="clinica">
                <!-- Options will be loaded dynamically -->
            </select>
            
            <label for="newSchedulingMedico">{{ text.doctor }}</label>
            <select id="newSchedulingMedico" name="medico">
                <!-- Options will be loaded dynamically -->
            </select>
            
            <label for="newSchedulingDataHora">{{ text.date_time }}</label>
            <input type="datetime-local" id="newSchedulingDataHora" name="dataHoraAgendamento">
            
            <button type="button" onclick="submitNewScheduling()">{{ text.create }}</button>
        </form>
    </div>
</div>

<div id="editSchedulingModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('editSchedulingModal')">&times;</span>
        <h3>{{ text.edit_scheduling }}</h3>
        <form id="editSchedulingForm">
            <input type="hidden" id="editSchedulingId" name="id">
            
            <label for="editSchedulingNome">{{ text.patient_name }}</label>
            <input type="text" id="editSchedulingNome" name="nomePaciente">
            
            <label for="editSchedulingEmail">{{ text.patient_email }}</label>
            <input type="email" id="editSchedulingEmail" name="emailPaciente">
            
            <label for="editSchedulingClinica">{{ text.clinic }}</label>
            <select id="editSchedulingClinica" name="clinica">
                <!-- Options will be loaded dynamically -->
            </select>
            
            <label for="editSchedulingMedico">{{ text.doctor }}</label>
            <select id="editSchedulingMedico" name="medico">
                <!-- Options will be loaded dynamically -->
            </select>
            
            <label for="editSchedulingDataHora">{{ text.date_time }}</label>
            <input type="datetime-local" id="editSchedulingDataHora" name="dataHoraAgendamento">
            
            <button type="button" onclick="submitSchedulingEdit()">{{ text.save_changes }}</button>
        </form>
    </div>
</div>

<div id="admin-content">
    <h2>{{ text.adm_panel }} - {{ text.scheduling_management }}</h2>
    <button onclick="showCreateSchedulingModal()" class="new-scheduling-btn">{{ text.new_registration }}</button>

    <table id="scheduling-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>{{ text.patient_name }}</th>
                <th>{{ text.patient_email }}</th>
                <th>{{ text.clinic }}</th>
                <th>{{ text.doctor }}</th>
                <th>{{ text.date_time }}</th>
                <th>{{ text.actions }}</th>
            </tr>
        </thead>
        <tbody>
            <!-- Os agendamentos serão carregados aqui via JavaScript -->
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        loadSchedulings();
        loadClinics();
        loadDoctors();
    });

    function loadSchedulings() {
        fetch('/api/agendamentos')
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('#scheduling-table tbody');
            tbody.innerHTML = ''; // Limpar o corpo da tabela existente
            data.forEach(scheduling => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-id', scheduling.id);
                tr.innerHTML = `
                    <td class="id">${scheduling.id}</td>
                    <td class="nomePaciente">${scheduling.nomePaciente}</td>
                    <td class="emailPaciente">${scheduling.emailPaciente}</td>
                    <td class="clinica">${scheduling.clinica.nome}</td>
                    <td class="medico">${scheduling.medico.nome}</td>
                    <td class="dataHoraAgendamento">${new Date(scheduling.dataHoraAgendamento).toLocaleString()}</td>
                    <td class="actions">
                        <button onclick="editScheduling('${scheduling.id}')" class="edit-btn action-btn">{{ text.edit }}</button>
                        <button onclick="deleteScheduling('${scheduling.id}')" class="delete-btn action-btn">{{ text.delete }}</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        })
        .catch(error => console.error('Erro ao buscar dados:', error));
    }

    function loadClinics() {
        fetch('/api/clinicas')
        .then(response => response.json())
        .then(data => {
            const selectNew = document.getElementById('newSchedulingClinica');
            const selectEdit = document.getElementById('editSchedulingClinica');
            data.forEach(clinic => {
                const option = document.createElement('option');
                option.value = clinic.id;
                option.textContent = clinic.nome;
                selectNew.appendChild(option);
                selectEdit.appendChild(option.cloneNode(true));
            });
        })
        .catch(error => console.error('Erro ao buscar clínicas:', error));
    }

    function loadDoctors() {
        fetch('/api/medicos')
        .then(response => response.json())
        .then(data => {
            const selectNew = document.getElementById('newSchedulingMedico');
            const selectEdit = document.getElementById('editSchedulingMedico');
            data.forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor.id;
                option.textContent = doctor.nome;
                selectNew.appendChild(option);
                selectEdit.appendChild(option.cloneNode(true));
            });
        })
        .catch(error => console.error('Erro ao buscar médicos:', error));
    }

    function editScheduling(id) {
        const schedulingRow = document.querySelector(`tr[data-id="${id}"]`);
        if (!schedulingRow) {
            console.error('Linha do agendamento não encontrada.');
            return;
        }

        const idScheduling = schedulingRow.querySelector('.id').textContent;
        const nomePaciente = schedulingRow.querySelector('.nomePaciente').textContent;
        const emailPaciente = schedulingRow.querySelector('.emailPaciente').textContent;
        const clinicaId = schedulingRow.querySelector('.clinica').dataset.id;
        const medicoId = schedulingRow.querySelector('.medico').dataset.id;
        const dataHoraAgendamento = new Date(schedulingRow.querySelector('.dataHoraAgendamento').textContent).toISOString().slice(0, 16);

        document.getElementById('editSchedulingId').value = idScheduling;
        document.getElementById('editSchedulingNome').value = nomePaciente;
        document.getElementById('editSchedulingEmail').value = emailPaciente;
        document.getElementById('editSchedulingClinica').value = clinicaId;
        document.getElementById('editSchedulingMedico').value = medicoId;
        document.getElementById('editSchedulingDataHora').value = dataHoraAgendamento;

        document.getElementById('editSchedulingModal').style.display = 'block';
    }

    function submitSchedulingEdit() {
        const id = document.getElementById('editSchedulingId').value;
        const nomePaciente = document.getElementById('editSchedulingNome').value;
        const emailPaciente = document.getElementById('editSchedulingEmail').value;
        const clinica = document.getElementById('editSchedulingClinica').value;
        const medico = document.getElementById('editSchedulingMedico').value;
        const dataHoraAgendamento = document.getElementById('editSchedulingDataHora').value;

        fetch('/api/agendamentos/atualizar/' + id, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ nomePaciente, emailPaciente, clinica, medico, dataHoraAgendamento })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw err; });
            }
            return response.json();
        })
        .then(data => {
            swal(data.message, "", "success").then(() => {
                window.location.reload();
            });
        })
        .catch(error => {
            console.error('Erro ao atualizar o agendamento:', error);
            swal("Erro ao atualizar o agendamento", error.message, "error");
        });
    }

    function deleteScheduling(id) {
        swal({
            title: "{{ text.delete_confirmation_title }}",
            text: "{{ text.delete_confirmation_text }}",
            icon: "warning",
            buttons: true,
            dangerMode: true,
        }).then((willDelete) => {
            if (willDelete) {
                fetch('/api/agendamentos/remover/' + id, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        swal("Agendamento removido com sucesso!", "", "success").then(() => {
                            window.location.reload();
                        });
                    } else if (response.status === 404) {
                        swal("Agendamento não encontrado", "", "error");
                    } else {
                        return response.json().then(err => { throw err; });
                    }
                })
                .catch(error => {
                    console.error('Erro ao remover agendamento:', error);
                    swal("Erro ao remover agendamento", error.message, "error");
                });
            }
        });
    }

    function showCreateSchedulingModal() {
        document.getElementById('createSchedulingModal').style.display = 'block';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    function submitNewScheduling() {
        const nomePaciente = document.getElementById('newSchedulingNome').value;
        const emailPaciente = document.getElementById('newSchedulingEmail').value;
        const clinica = document.getElementById('newSchedulingClinica').value;
        const medico = document.getElementById('newSchedulingMedico').value;
        const dataHoraAgendamento = document.getElementById('newSchedulingDataHora').value;

        fetch('/api/agendamentos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ nomePaciente, emailPaciente, clinica, medico, dataHoraAgendamento })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw err; });
            }
            return response.json();
        })
        .then(data => {
            swal(data.message, "", "success").then(() => {
                window.location.reload();
            });
        })
        .catch(error => {
            console.error('Erro ao criar novo agendamento:', error);
            swal("Erro ao criar novo agendamento", error.message, "error");
        });
    }
</script>

